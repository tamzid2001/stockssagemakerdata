name: Social Media Automation

on:
  schedule:
    - cron: "35 */6 * * *" # every 6 hours
  workflow_dispatch:

permissions:
  contents: read

jobs:
  social-automation:
    runs-on: ubuntu-latest
    env:
      GOOGLE_CLOUD_PROJECT: quantura-e2e3d
      FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_QUANTURA_E2E3D || secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || secrets.OPENAI_API_KEY_PROD }}
      SOCIAL_DEFAULT_CTA_URL: https://quantura-e2e3d.web.app
      SOCIAL_AUTOPILOT_USER_ID: quantura_system
      SOCIAL_AUTOPILOT_USER_EMAIL: system@quantura.ai
      TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN || secrets.X_BEARER_TOKEN }}
      TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY || secrets.X_API_KEY }}
      TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET || secrets.X_API_SECRET }}
      TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN || secrets.X_ACCESS_TOKEN }}
      TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET || secrets.X_ACCESS_TOKEN_SECRET }}
      LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN || secrets.LINKEDIN_TOKEN }}
      LINKEDIN_AUTHOR_URN: ${{ secrets.LINKEDIN_AUTHOR_URN || secrets.LINKEDIN_ORGANIZATION_URN }}
      FACEBOOK_PAGE_ID: ${{ secrets.FACEBOOK_PAGE_ID }}
      FACEBOOK_PAGE_ACCESS_TOKEN: ${{ secrets.FACEBOOK_PAGE_ACCESS_TOKEN }}
      INSTAGRAM_BUSINESS_ACCOUNT_ID: ${{ secrets.INSTAGRAM_BUSINESS_ACCOUNT_ID }}
      INSTAGRAM_ACCESS_TOKEN: ${{ secrets.INSTAGRAM_ACCESS_TOKEN || secrets.FACEBOOK_PAGE_ACCESS_TOKEN }}
      INSTAGRAM_DEFAULT_IMAGE_URL: ${{ secrets.INSTAGRAM_DEFAULT_IMAGE_URL }}
      TIKTOK_ACCESS_TOKEN: ${{ secrets.TIKTOK_ACCESS_TOKEN }}
      TIKTOK_OPEN_ID: ${{ secrets.TIKTOK_OPEN_ID }}
      SOCIAL_WEBHOOK_X: ${{ secrets.SOCIAL_WEBHOOK_X }}
      SOCIAL_WEBHOOK_LINKEDIN: ${{ secrets.SOCIAL_WEBHOOK_LINKEDIN }}
      SOCIAL_WEBHOOK_FACEBOOK: ${{ secrets.SOCIAL_WEBHOOK_FACEBOOK }}
      SOCIAL_WEBHOOK_INSTAGRAM: ${{ secrets.SOCIAL_WEBHOOK_INSTAGRAM }}
      SOCIAL_WEBHOOK_TIKTOK: ${{ secrets.SOCIAL_WEBHOOK_TIKTOK }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r quantura_site/functions/requirements.txt

      - name: Run social channel probe
        run: |
          python scripts/social_channel_probe.py --query "US stock market top headlines today" --limit 6

      - name: Write Firebase service account
        if: env.FIREBASE_SERVICE_ACCOUNT_JSON != ''
        run: |
          echo "${FIREBASE_SERVICE_ACCOUNT_JSON}" > /tmp/firebase-service-account.json
          chmod 600 /tmp/firebase-service-account.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-service-account.json" >> $GITHUB_ENV
          echo "SERVICE_ACCOUNT_PATH=/tmp/firebase-service-account.json" >> $GITHUB_ENV

      - name: Queue and dispatch social autopilot
        if: env.FIREBASE_SERVICE_ACCOUNT_JSON != ''
        run: |
          python scripts/social_poster_runner.py \
            --channels "x,linkedin,facebook,instagram,tiktok" \
            --posts-per-channel 2 \
            --send-now \
            --queue-strategic \
            --publish-now-first \
            --dispatch-due \
            --dispatch-limit 30 \
            --schedule-autopilot

      - name: Skip note (missing Firebase service account)
        if: env.FIREBASE_SERVICE_ACCOUNT_JSON == ''
        run: |
          echo "### Social automation skipped" >> $GITHUB_STEP_SUMMARY
          echo "- Add FIREBASE_SERVICE_ACCOUNT_QUANTURA_E2E3D or FIREBASE_SERVICE_ACCOUNT_JSON secret to enable queue + dispatch automation." >> $GITHUB_STEP_SUMMARY
